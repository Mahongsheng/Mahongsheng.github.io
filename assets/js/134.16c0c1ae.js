(window.webpackJsonp=window.webpackJsonp||[]).push([[134],{566:function(t,s,a){"use strict";a.r(s);var n=a(16),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"tinykv总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tinykv总结"}},[t._v("#")]),t._v(" TinyKV总结")]),t._v(" "),a("p",[a("code",[t._v("TinyKV")]),t._v("是"),a("code",[t._v("PingCAP")]),t._v("公司推出的一套开源分布式"),a("code",[t._v("KV")]),t._v("存储实战课程，这课程一共包含了"),a("code",[t._v("4")]),t._v("子项目：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("Project 1")]),t._v("需要参与者独立完成一个单机的"),a("code",[t._v("KV Server")])]),t._v(" "),a("li",[a("code",[t._v("Project 2")]),t._v("需要基于"),a("code",[t._v("Raft")]),t._v("算法实现分布式键值数据库服务端")]),t._v(" "),a("li",[a("code",[t._v("Project 3")]),t._v("需要"),a("code",[t._v("在Project 2")]),t._v("的基础上支持多个"),a("code",[t._v("Raft")]),t._v("集群")]),t._v(" "),a("li",[a("code",[t._v("Project 4")]),t._v("需要"),a("code",[t._v("Project 3")]),t._v("的基础上支持分布式事务")])]),t._v(" "),a("h2",{attrs:{id:"project-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-1"}},[t._v("#")]),t._v(" Project 1")]),t._v(" "),a("p",[a("code",[t._v("Project 1")]),t._v("是要基于"),a("code",[t._v("BadgerDB")]),t._v("作为存储引擎的去实现出题者预留的"),a("code",[t._v("API")]),t._v("接口，包括")]),t._v(" "),a("ol",[a("li",[t._v("Implement a standalone storage engine.")]),t._v(" "),a("li",[t._v("Implement raw key-value service handlers.")])]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("BadgerDB")]),t._v("是"),a("code",[t._v("dgraph.io")]),t._v("开发的一款基于 "),a("code",[t._v("Log Structured Merge (LSM) Tree")]),t._v(" 的 "),a("code",[t._v("key-value")]),t._v(" 本地数据库， 使用"),a("code",[t._v("Go")]),t._v(" 开发。")])]),t._v(" "),a("p",[t._v("注意在这里面，因为Badger 不支持列族（column families）。所以要用engine_util 包 ( "),a("code",[t._v("kv/util/engine_util")]),t._v(") 向键添加前缀来模拟列族。例如，"),a("code",[t._v("key")]),t._v("属于特定列族的键"),a("code",[t._v("cf")]),t._v("存储为"),a("code",[t._v("${cf}_${key}")]),t._v(". 它通过 CF 进行包装"),a("code",[t._v("badger")]),t._v("以提供操作，并且还提供了许多有用的辅助函数。")]),t._v(" "),a("p",[t._v("关于列族可以看这篇文章："),a("a",{attrs:{href:"https://juejin.cn/post/6844903750012780558",target:"_blank",rel:"noopener noreferrer"}},[t._v("五分钟轻松了解Hbase列式存储"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"project-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-2"}},[t._v("#")]),t._v(" Project 2")]),t._v(" "),a("p",[a("code",[t._v("Project 2")]),t._v("是要基于"),a("code",[t._v("Raft")]),t._v("算法实现分布式键值数据库服务端，其包含以下三个子实验：")]),t._v(" "),a("ol",[a("li",[t._v("实现基本的 Raft 算法")]),t._v(" "),a("li",[t._v("在 Raft 之上建立一个容错的KV服务")]),t._v(" "),a("li",[t._v("增加对 raftlog GC 和快照的支持")])]),t._v(" "),a("h3",{attrs:{id:"project-2a"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-2a"}},[t._v("#")]),t._v(" Project 2A")]),t._v(" "),a("p",[t._v("在这一部分我们主要需要实现以下三个部分：")]),t._v(" "),a("ol",[a("li",[t._v("Leader选举")]),t._v(" "),a("li",[t._v("日志复制")]),t._v(" "),a("li",[t._v("RawNode接口")])]),t._v(" "),a("p",[t._v("数据结构整体关系如下图：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://imgtu.com/i/jkA8Cn",target:"_blank",rel:"noopener noreferrer"}},[a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://s1.ax1x.com/2022/06/25/jkA8Cn.png",alt:"jkA8Cn.png"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Raft结构如下：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Raft "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tid "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\tTerm "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\tVote "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the log")]),t._v("\n\tRaftLog "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("RaftLog\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// log replication progress of each peers")]),t._v("\n\tPrs "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Progress\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this peer's role")]),t._v("\n\tState StateType\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// votes records")]),t._v("\n\tvotes "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// msgs need to send")]),t._v("\n\tmsgs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the leader id")]),t._v("\n\tLead "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\theartbeatTimeout "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\n\telectionTimeout "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\n\theartbeatElapsed "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\n\telectionElapsed "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\n\tleadTransferee "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\tPendingConfIndex "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br")])]),a("p",[t._v("一个重要的数据结构是RaftLog：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" RaftLog "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// storage contains all stable entries since the last snapshot.")]),t._v("\n\tstorage Storage\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// committed is the highest log position that is known to be in")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// stable storage on a quorum of nodes.")]),t._v("\n\tcommitted "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// applied is the highest log position that the application has")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// been instructed to apply to its state machine.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Invariant: applied <= committed")]),t._v("\n\tapplied "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// log entries with index <= stabled are persisted to storage.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// It is used to record the logs that are not persisted by storage yet.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Everytime handling `Ready`, the unstabled logs will be included.")]),t._v("\n\tstabled "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// all entries that have not yet compact.")]),t._v("\n\tentries "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the incoming unstable snapshot, if any.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// (Used in 2C)")]),t._v("\n\tpendingSnapshot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Your Data Here (2A).")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br")])]),a("p",[t._v("在"),a("code",[t._v("RaftLog")]),t._v("中使用"),a("code",[t._v("Storage")]),t._v("作为持久化存储，它实际是一个接口：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Storage "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// InitialState returns the saved HardState and ConfState information.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("InitialState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConfState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Entries returns a slice of log entries in the range [lo,hi).")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// MaxSize limits the total size of the log entries returned, but")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Entries returns at least one entry if any.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Entries")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hi "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Term returns the term of entry i, which must be in the range")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// [FirstIndex()-1, LastIndex()]. The term of the entry before")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FirstIndex is retained for matching purposes even though the")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// rest of that entry may not be available.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Term")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// LastIndex returns the index of the last entry in the log.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LastIndex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// FirstIndex returns the index of the first log entry that is")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// possibly available via Entries (older entries have been incorporated")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// into the latest Snapshot; if storage only contains the dummy entry the")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// first log entry is not available).")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FirstIndex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Snapshot returns the most recent snapshot.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If snapshot is temporarily unavailable, it should return ErrSnapshotTemporarilyUnavailable,")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// so raft state machine could know that Storage needs some time to prepare")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// snapshot and call Snapshot later.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Snapshot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])]),a("p",[t._v("在框架代码中使用内存实际存储，定义了结构体"),a("code",[t._v("MemoryStorage")]),t._v("实现接口：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" MemoryStorage "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Protects access to all fields. Most methods of MemoryStorage are")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// run on the raft goroutine, but Append() is run on an application")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// goroutine.")]),t._v("\n\tsync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mutex\n\n\thardState pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState\n\tsnapshot  pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ents[i] has raft log position i+snapshot.Metadata.Index")]),t._v("\n\tents "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("h4",{attrs:{id:"leader选举"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#leader选举"}},[t._v("#")]),t._v(" Leader选举")]),t._v(" "),a("p",[t._v("该部分主要是实现 "),a("a",{attrs:{href:"https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md#52-%E9%A2%86%E5%AF%BC%E4%BA%BA%E9%80%89%E4%B8%BE",target:"_blank",rel:"noopener noreferrer"}},[t._v("Raft 5.2领导人选举"),a("OutboundLink")],1),t._v("，由于算法本身涉及到的细节比较多，并且对框架代码不是很熟悉，一开始就有无从下手的感觉，所以基本上是面向测试编程，运行"),a("code",[t._v("make project2aa")]),t._v("来执行测试代码，根据测试代码的思路以及出错的位置来补充完善代码直到通过所有测试，现总结该部分如下：")]),t._v(" "),a("p",[t._v("首先完善创建各个结构体的函数，比如"),a("code",[t._v("newRaft()")]),t._v("、"),a("code",[t._v("newLog()")]),t._v("，然后完善"),a("code",[t._v("becomeFollower()")]),t._v("、"),a("code",[t._v("becomeCandidate()")]),t._v("、"),a("code",[t._v("becomeLeader()")]),t._v("函数对Raft状态进行转换。接着实现逻辑时钟函数"),a("code",[t._v("tick()")]),t._v("，来对心跳包和选举进行计时并判断是否超时。需要实现的最核心的函数是"),a("code",[t._v("Step()")]),t._v("，它对Raft收到的各种消息进行处理。")]),t._v(" "),a("h4",{attrs:{id:"日志复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志复制"}},[t._v("#")]),t._v(" 日志复制")]),t._v(" "),a("p",[t._v("这一部分主要是实现"),a("a",{attrs:{href:"https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md#53-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("Raft5.3 日志复制"),a("OutboundLink")],1),t._v("，涉及到日志复制的很多细节，拖的时间有点长。同样的是面对测试编程，通过测试来了解需要实现哪些功能，然后疯狂解决测试中出现的Bug。")]),t._v(" "),a("p",[t._v("该部分与前面的领导人选举实现的模块是一样的，涉及"),a("code",[t._v("raft.go")]),t._v("和"),a("code",[t._v("log.go")]),t._v("两个文件。主要是增加了对"),a("code",[t._v("MsgAppend")]),t._v("和"),a("code",[t._v("MsgAppendResponse")]),t._v("两类消息的处理，即 Leader 节点会接收客户端对数据库的操作并将其添加到自己的日志中，Leader 会将这些日志条目通过"),a("code",[t._v("MsgAppend")]),t._v("消息并行地发送给其他节点以保证数据库的一致性，其他节点则通过"),a("code",[t._v("MsgAppendResponse")]),t._v("消息告知 Leader 日志的复制是否成功。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://imgtu.com/i/jHeeC8",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://s1.ax1x.com/2022/07/19/jHeeC8.png",alt:"jHeeC8.png"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("考虑几种异常情况：")]),t._v(" "),a("ol",[a("li",[t._v("图中的情况a和b是日志缺失的情况。这时我们通过检查"),a("code",[t._v("Follower")]),t._v("的日志有没有这个"),a("code",[t._v("Next-1")]),t._v("日志。如果没有，说明日志缺失，返回拒绝日志的"),a("code",[t._v("AppendResp")]),t._v("，消息要附加自己的最后一条日志的"),a("code",[t._v("Term")]),t._v("和"),a("code",[t._v("Index")]),t._v("。领导者收到拒绝的消息后更新这个节点的"),a("code",[t._v("Prs")]),t._v("的"),a("code",[t._v("Next和Match")]),t._v("到返回的"),a("code",[t._v("Index+1")]),t._v("和"),a("code",[t._v("Index")]),t._v("然后重发消息（这里需要实现成立即重发）")]),t._v(" "),a("li",[t._v("图中的情况c和d是日志过多的情况。这时"),a("code",[t._v("Follower")]),t._v("是有"),a("code",[t._v("Next-1")]),t._v("日志的，然后"),a("code",[t._v("Follower")]),t._v("在追加日志时就要把自己的和"),a("code",[t._v("Leader")]),t._v("日志不一致的地方丢掉，然后再追加日志")]),t._v(" "),a("li",[t._v("图中的情况e和f是日志冲突的情况，这是"),a("code",[t._v("Follower")]),t._v("没有"),a("code",[t._v("Next-1")]),t._v("日志，发送拒绝，同时附加和Append消息的Index对应的消息的Term，领导者收到这个拒收的时候找到小于等于该任期的Index最大的消息，然后重发，可以发现，多次调整之后，这个"),a("code",[t._v("Follower")]),t._v("的状态可以回到日志缺失的状态。同时领导者处理拒绝的流程和a，b状态下的是一致的。")])]),t._v(" "),a("h4",{attrs:{id:"rawnode接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rawnode接口"}},[t._v("#")]),t._v(" RawNode接口")]),t._v(" "),a("p",[a("code",[t._v("raft/rawnode.go")]),t._v("中的"),a("code",[t._v("raft.RawNode")]),t._v("是为上层应用提供的接口：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" RawNode "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tRaft "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Raft\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Your Data Here (2A).")]),t._v("\n\tLead      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\tState     StateType\n\tHardState pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("它包含了"),a("code",[t._v("raft.Raft")]),t._v("并且提供了一些函数如"),a("code",[t._v("Rawnode.Tick()")]),t._v("和"),a("code",[t._v("Rawnode.Step()")]),t._v("，并且还提供了"),a("code",[t._v("RawNode.Proposal()")]),t._v("来让上层应用附加新的raft日志。在客户端提出一个操作请求后，"),a("code",[t._v("raft.Raft")]),t._v("需要做的有：")]),t._v(" "),a("ul",[a("li",[t._v("给其他节点发送消息")]),t._v(" "),a("li",[t._v("保存日志信息到持久化存储中")]),t._v(" "),a("li",[t._v("保存状态信息如term、commit index、vote等")]),t._v(" "),a("li",[t._v("将日志中的操作应用在状态机中")])]),t._v(" "),a("p",[t._v("但是这些操作并不是在"),a("code",[t._v("Raft")]),t._v("中立即执行的，他们被包含在"),a("code",[t._v("Ready")]),t._v("结构体中并通过"),a("code",[t._v("RawNode.Ready()")]),t._v("返回给上层逻辑处理，上层在处理完获取到的"),a("code",[t._v("Ready")]),t._v("内容后调用"),a("code",[t._v("RawNode.Advance()")]),t._v("来更新"),a("code",[t._v("raft.Raft")]),t._v("的应用日志索引和存储日志索引等状态。")]),t._v(" "),a("p",[a("code",[t._v("Ready")]),t._v("结构体主要包含的内容有：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Ready "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The current volatile state of a Node.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// SoftState will be nil if there is no update.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// It is not required to consume or store SoftState.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("SoftState\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The current state of a Node to be saved to stable storage BEFORE")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Messages are sent.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// HardState will be equal to empty state if there is no update.")]),t._v("\n\tpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Entries specifies entries to be saved to stable storage BEFORE")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Messages are sent.")]),t._v("\n\tEntries "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Snapshot specifies the snapshot to be saved to stable storage.")]),t._v("\n\tSnapshot pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// CommittedEntries specifies entries to be committed to a")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store/state-machine. These have previously been committed to stable")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store.")]),t._v("\n\tCommittedEntries "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Messages specifies outbound messages to be sent AFTER Entries are")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// committed to stable storage.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If it contains a MessageType_MsgSnapshot message, the application MUST report back to raft")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// when the snapshot has been received or has failed by calling ReportSnapshot.")]),t._v("\n\tMessages "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br")])]),a("p",[t._v("也就是需要保存的节点状态、应用的日志、存储的日志、保存的快照以及处理的消息，这些是一个Raft系统正常运转所需要处理的内容。我们在"),a("code",[t._v("RawNode.Ready()")]),t._v("中根据节点的实际信息来构建"),a("code",[t._v("ready")]),t._v("结构体，在"),a("code",[t._v("RawNode.Advance()")]),t._v("中更新所有内容处理后的状态和索引信息。")]),t._v(" "),a("h3",{attrs:{id:"project-2b"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-2b"}},[t._v("#")]),t._v(" Project 2B")]),t._v(" "),a("p",[t._v("Part B 的目标是使用之前实现的Raft算法来构建一个可容错的键值存储服务，实际上就是包含多个键值服务器，使用Raft算法来进行复制的复制状态机。")]),t._v(" "),a("p",[t._v("在 TiKV 中，数据按照 key 的范围划分成了大致相等的切片（Region），每一个切片会有多个副本（通常是3个），其中一个副本是Leader，提供读写服务。各个副本分布在不同的存储节点（Store）中，每个实际的服务器（TiKV node）可以有多个store。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://imgtu.com/i/jkEsoQ",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://s1.ax1x.com/2022/06/25/jkEsoQ.png",alt:"jkEsoQ.png"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("类似的，TinyKV中使用了"),a("code",[t._v("Store")]),t._v("、"),a("code",[t._v("Peer")]),t._v("和"),a("code",[t._v("Region")]),t._v("的概念，"),a("code",[t._v("Store")]),t._v("代表tinykv服务器实例，"),a("code",[t._v("Peer")]),t._v("代表运行在Store上的Raft节点，"),a("code",[t._v("Region")]),t._v("是一系列Peers的集合，也称为Raft Group。在Project2中，只考虑每个Store上一个Peer，总共一个Region的简单情况。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://imgtu.com/i/jkVA6P",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://s1.ax1x.com/2022/06/25/jkVA6P.png",alt:"jkVA6P.png"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("在Project1中，我们实现过单机的键值存储"),a("code",[t._v("StandaloneStorage")]),t._v("，直接读写底层的存储引擎，但是在这一部分我们要重新实现"),a("code",[t._v("Storage")]),t._v("接口，也就是"),a("code",[t._v("RaftStorage")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" RaftStorage "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tengines "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Engines\n\tconfig  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Config\n\n\tnode          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raftstore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Node\n\tsnapManager   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("snap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SnapManager\n\traftRouter    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raftstore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftstoreRouter\n\traftSystem    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raftstore"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Raftstore\n\tresolveWorker "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("worker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Worker\n\tsnapWorker    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("worker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Worker\n\n\twg sync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WaitGroup\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[a("code",[t._v("RaftStorage")]),t._v("中Raft一致性算法的实现主要使用的是"),a("code",[t._v("RaftStore")]),t._v(",它在启动时会创建一系列线程处理不同的任务，其中就包括负责处理Raft的线程"),a("code",[t._v("raftWorker")])]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Raftstore "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tctx        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("GlobalContext\n\tstoreState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("storeState\n\trouter     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("router\n\tworkers    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("workers\n\ttickDriver "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tickDriver\n\tcloseCh    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\twg         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WaitGroup\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("当调用"),a("code",[t._v("RaftStorage")]),t._v("的"),a("code",[t._v("Reader")]),t._v("和"),a("code",[t._v("Write")]),t._v("方法时，它实际上会通过"),a("code",[t._v("raftWorker")]),t._v("中 的"),a("code",[t._v("raftCh")]),t._v("接收通道向"),a("code",[t._v("raftstore")]),t._v("发送"),a("code",[t._v("RaftCmdRequest")]),t._v("（包含Get/Put/Delete/Snap四种基本的操作类型），当命令在raft中被提交以及执行后，会返回结果给"),a("code",[t._v("RaftStorage")]),t._v("，这样也就保证了读写操作在多节点中的一致性。")]),t._v(" "),a("h4",{attrs:{id:"实现-peer-storage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现-peer-storage"}},[t._v("#")]),t._v(" 实现 peer storage")]),t._v(" "),a("p",[a("code",[t._v("PeerStorage")]),t._v("是替代Part A中"),a("code",[t._v("MemoryStorage")]),t._v("进行实际存储的结构体：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" PeerStorage "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// current region information of the peer")]),t._v("\n\tregion "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("metapb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Region\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// current raft state of the peer")]),t._v("\n\traftState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("rspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLocalState\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// current apply state of the peer")]),t._v("\n\tapplyState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("rspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftApplyState\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// current snapshot state")]),t._v("\n\tsnapState snap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SnapState\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// regionSched used to schedule task to region worker")]),t._v("\n\tregionSched "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" worker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Task\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// generate snapshot tried count")]),t._v("\n\tsnapTriedCnt "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Engine include two badger instance: Raft and Kv")]),t._v("\n\tEngines "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Engines\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Tag used for logging")]),t._v("\n\tTag "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("p",[t._v("它底层使用的 Engines 包含 Kv 和 Raft 两个 badger.DB")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Engines "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Data, including data which is committed (i.e., committed across other nodes) and un-committed (i.e., only present")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// locally).")]),t._v("\n\tKv     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("badger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DB\n\tKvPath "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Metadata used by Raft.")]),t._v("\n\tRaft     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("badger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DB\n\tRaftPath "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[a("code",[t._v("PeerStorage")]),t._v("除了存储raft日志和实际的数据外，也会存储一些非常重要的元信息，如：")]),t._v(" "),a("ul",[a("li",[t._v("RaftLocalState：存储当前Raft的HardState和最后的日志索引")]),t._v(" "),a("li",[t._v("RaftApplyState：存储Raft最后应用的日志索引和截断的日志信息")]),t._v(" "),a("li",[t._v("RegionLocalState：存储Region的信息和当前Store对应的Peer状态")])]),t._v(" "),a("p",[t._v("这些状态被存在raftdb和kvdb中，在框架代码"),a("code",[t._v("kv/raftstore/meta")]),t._v("中已经实现了编码函数，在实际存储过程中可以直接调用。")]),t._v(" "),a("p",[t._v("在这一部分需要实现的函数是"),a("code",[t._v("PeerStorage.SaveReadyState")]),t._v("，这个函数将"),a("code",[t._v("raft.Ready")]),t._v("中的日志和状态等信息存储进badger数据库中。"),a("strong",[t._v("在存储日志时需要删掉后面可能存在的无效日志")]),t._v("，而状态信息则调用对应的编码函数获取key值进行写入。在实际写数据的时候使用"),a("code",[t._v("WriteBatch")]),t._v("结构体，它提供了函数对数据一次性写入，提升效率。")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("PeerStorage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SaveReadyState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ready "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ApplySnapResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Hint: you may call `Append()` and `ApplySnapshot()` in this function")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Your Code Here (2B/2C).")]),t._v("\n\traftWB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WriteBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ApplySnapResult\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("raft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsEmptySnap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tkvWB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WriteBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tresult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ApplySnapshot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kvWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" raftWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tkvWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteToDB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Engines"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Kv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HardState\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entries"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" raftWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" raftWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetMeta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("meta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("RaftStateKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" raftWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteToDB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Engines"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Raft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])]),a("h4",{attrs:{id:"实现-raft-ready-process"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现-raft-ready-process"}},[t._v("#")]),t._v(" 实现 Raft ready process")]),t._v(" "),a("p",[t._v("在框架代码中"),a("code",[t._v("raftWorker")]),t._v("负责处理Raft信息：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raftWorker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("closeCh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WaitGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" wg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" msgs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Msg\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tmsgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("closeCh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftCh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t\tmsgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tpending "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftCh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" pending"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tmsgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftCh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tpeerStateMap "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("peerState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" msgs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tpeerState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPeerState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("peerStateMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RegionID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" peerState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("newPeerMsgHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("peerState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleMsg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" peerState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" peerStateMap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("newPeerMsgHandler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("peerState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleRaftReady")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br")])]),a("p",[t._v("可以看到，在"),a("code",[t._v("raftWorker")]),t._v("收到消息后，消息中对应的"),a("code",[t._v("peer")]),t._v("会被包装进"),a("code",[t._v("peerMsgHandler")]),t._v("，首先对消息（"),a("code",[t._v("MsgTypeTick")]),t._v(", "),a("code",[t._v("MsgTypeRaftCmd")]),t._v(", "),a("code",[t._v("MsgTypeRaftMessage")]),t._v("）调用"),a("code",[t._v("HandleMsgs")]),t._v("处理，然后调用"),a("code",[t._v("HandleRaftReady")]),t._v("获取"),a("code",[t._v("Ready")]),t._v("信息处理。")]),t._v(" "),a("p",[t._v("Raft的处理步骤可以概括为：")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Ticker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    Node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Tick")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" Node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HasReady")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      rd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" Node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Ready")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("saveToStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("State"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entries"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Messages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entry "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CommittedEntries "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("process")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Advance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("p",[t._v("读写操作的执行流程可以概括为：")]),t._v(" "),a("ul",[a("li",[t._v("客户端调用RPC RawGet/RawPut/RawDelete/RawScan")]),t._v(" "),a("li",[t._v("RPC handler 调用"),a("code",[t._v("RaftStorage")]),t._v("中的相关读写方法")]),t._v(" "),a("li",[a("code",[t._v("RaftStorage")]),t._v("向"),a("code",[t._v("raftstore")]),t._v("发送Raft命令请求并等待回复")]),t._v(" "),a("li",[a("code",[t._v("RaftStore")]),t._v("将Raft命令作为Raft日志写入"),a("code",[t._v("PeerStorage")]),t._v("并同步")]),t._v(" "),a("li",[t._v("Raft模型提交日志")]),t._v(" "),a("li",[t._v("Raft worker执行Raft命令并处理Raft ready，将结果通过callback返回")]),t._v(" "),a("li",[a("code",[t._v("RaftStorage")]),t._v("接收到结果并返回给RPC handler")]),t._v(" "),a("li",[t._v("RPC handler处理得到结果返回给客户端")])]),t._v(" "),a("p",[t._v("在执行过程中有一些错误情况，相关的error可以直接包装进"),a("code",[t._v("RaftCmdResponse")]),t._v("中的"),a("code",[t._v("RaftResponseHeader")]),t._v("中返回。具体的，可以直接使用"),a("code",[t._v("kv/raftstore/cmd_resp.go")]),t._v("中提供的"),a("code",[t._v("BindErrResp")]),t._v("。在当前需要考虑的错误有：")]),t._v(" "),a("ul",[a("li",[t._v("ErrNotLeader：raft命令被发送到了follower上，需要告知客户端尝试其他的peers")]),t._v(" "),a("li",[t._v("ErrStaleCommand：某些命令的raft日志可能并没有被提交，而且被新的日志所覆盖，但客户端可能仍在等待返回结果，所以需要告知客户端重新执行命令")])]),t._v(" "),a("h3",{attrs:{id:"project-2c"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-2c"}},[t._v("#")]),t._v(" Project 2C")]),t._v(" "),a("p",[t._v("在实际的存储系统中，raft日志会随时间不断增多，然而存储大量的日志信息会影响系统的存储空间和运行效率。因此，当日志长度超过一定的阈值时，系统会生成快照并丢弃无用的日志信息，实现日志的压缩。")]),t._v(" "),a("p",[t._v("实际上快照Snapshot和AppendEntries一样，是一个需要同步给follower的raft消息。不同的是快照的规模很大，包含了某个时间点整个状态机的数据，所以快照消息会使用独立的连接传输数据。")]),t._v(" "),a("h4",{attrs:{id:"本地生成快照"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#本地生成快照"}},[t._v("#")]),t._v(" 本地生成快照")]),t._v(" "),a("p",[t._v("Raftstore在每次时钟"),a("code",[t._v("OnRaftGcLogTick()")]),t._v("中都会检测日志的长度是否超过了设定的阈值"),a("code",[t._v("RaftLogGcCountLimit")]),t._v("，如果是，则会发送一个raft管理命令"),a("code",[t._v("CompactLogRequest")]),t._v("，被包装在"),a("code",[t._v("RaftCmdRequest")]),t._v("（与Get/Put/Delete/Snap相同），在经过Raft提交后，每个节点都会执行该日志压缩的命令，向 raftlog-gc 线程发送"),a("code",[t._v("ScheduleCompactLog")]),t._v("任务，生成快照。")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("d "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("peerMsgHandler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("processAdminRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entry "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("eraftpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Entry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("raft_cmdpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftCmdRequest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wb "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WriteBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\treq "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AdminRequest\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("switch")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CmdType "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" raft_cmdpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AdminCmdType_ChangePeer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" raft_cmdpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AdminCmdType_CompactLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\tcompactLog "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CompactLog\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" compactLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CompactIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("peerStorage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TruncatedState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\td"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("peerStorage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TruncatedState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compactLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CompactIndex\n\t\t\td"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("peerStorage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TruncatedState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compactLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CompactTerm\n\t\t\td"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ScheduleCompactLog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("compactLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CompactIndex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" raft_cmdpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AdminCmdType_TransferLeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" raft_cmdpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AdminCmdType_Split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("h4",{attrs:{id:"发送与接收快照"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#发送与接收快照"}},[t._v("#")]),t._v(" 发送与接收快照")]),t._v(" "),a("p",[t._v("如果需要给Follower发送的日志信息已经被压缩，这时候Leader则需向Follower发送快照。Leader调用"),a("code",[t._v("Storage.Snapshot()")]),t._v("向region worker发送"),a("code",[t._v("RegionTaskGen")]),t._v("生成快照，之后再次调用该函数时会检测快照生成是否完成，如果完成就返回快照用于发送。")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Raft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sendAppend")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("to "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tindex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Prs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\tlogTerm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Term")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" ErrCompacted "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsnapShot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("storage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Snapshot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tMsgType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageType_MsgSnapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tFrom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("     r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tTo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tTerm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("     r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tSnapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("snapShot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Prs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" snapShot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br")])]),a("p",[t._v("Follower在接收到快照快照消息后，会在"),a("code",[t._v("onRaftMsg")]),t._v("中进行具体的快照接收，然后调用"),a("code",[t._v("handleSnapshot")]),t._v("来处理消息，修改term、commit index和集群成员等信息。")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Raft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleSnapshot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Your Code Here (2C).")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("becomeFollower")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("From"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tmetadata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("committed "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tMsgType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageType_MsgAppendResponse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tFrom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tTo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("From"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tTerm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tIndex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("   r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("committed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("committed "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applied "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stabled "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pendingSnapshot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Prs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Progress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("votes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConfState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Nodes "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Prs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("Progress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("votes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("msgs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tMsgType"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageType_MsgAppendResponse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tFrom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tTo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("      m"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("From"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tTerm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tIndex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("   metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br")])]),a("p",[t._v("修改的信息会被反应到"),a("code",[t._v("Ready")]),t._v("中来处理，在"),a("code",[t._v("ApplySnapshot")]),t._v("中，向region worker发送"),a("code",[t._v("runner.RegionTaskApply")]),t._v("应用快照，并更新"),a("code",[t._v("RaftLocalState")]),t._v(". "),a("code",[t._v("RaftApplyState")]),t._v(", "),a("code",[t._v("RegionLocalState")]),t._v("等状态，持久化写入kvdb和raftdb中。")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Apply the peer with given snapshot")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("PeerStorage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ApplySnapshot")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("snapshot "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("eraftpb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" kvWB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WriteBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" raftWB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("engine_util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WriteBatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ApplySnapResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Infof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%v begin to apply snapshot"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Tag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tsnapData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftSnapshotData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" snapData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Unmarshal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Hint: things need to do here including: update peer storage state like raftState and applyState, etc,")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// and send RegionTaskApply task to region worker through ps.regionSched, also remember call ps.clearMeta")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// and ps.clearExtraData to delete stale data")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Your Code Here (2C).")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearMeta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("kvWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" raftWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearExtraData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("snapData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("snapState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StateType "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" snap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SnapState_Applying\n\tnotifier "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("regionSched "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" runner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RegionTaskApply"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tRegionId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tNotifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" notifier"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tSnapMeta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tStartKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StartKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tEndKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("   ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("notifier\n\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LastIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("raftState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LastTerm "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppliedIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index\n\tps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("TruncatedState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("rspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RaftTruncatedState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Term"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\tkvWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetMeta")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("meta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ApplyStateKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("applyState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tresult "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ApplySnapResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("PrevRegion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" snapData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tmeta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteRegionState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("kvWB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" snapData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PeerState_Normal"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br")])]),a("h2",{attrs:{id:"project-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-3"}},[t._v("#")]),t._v(" Project 3")]),t._v(" "),a("h2",{attrs:{id:"project-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#project-4"}},[t._v("#")]),t._v(" Project 4")]),t._v(" "),a("h2",{attrs:{id:"巨人的肩膀"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#巨人的肩膀"}},[t._v("#")]),t._v(" 巨人的肩膀：")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://github.com/talent-plan/tinykv",target:"_blank",rel:"noopener noreferrer"}},[t._v("课程地址"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://chenyunong.com/2021/08/04/TinyKV-Project2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("TinyKV Project2 RaftKV"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md#53-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6",target:"_blank",rel:"noopener noreferrer"}},[t._v("寻找一种易于理解的一致性算法（扩展版）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://tanxinyu.work/tinykv",target:"_blank",rel:"noopener noreferrer"}},[t._v("TinyKV学习总结"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);