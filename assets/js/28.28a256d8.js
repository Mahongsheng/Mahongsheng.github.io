(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{459:function(s,n,t){"use strict";t.r(n);var a=t(16),e=Object(a.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-安装docker-engine"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装docker-engine"}},[s._v("#")]),s._v(" 1. 安装Docker Engine")]),s._v(" "),t("p",[s._v("在Windows和Linux服务器上配置Docker Engine的方式是不同的，由于Docker使用的是基于Linux虚拟化技术，故在Windows上进行配置需要WSL(Windows Subsystem for Linux)环境的支持，幸运的是，Docker在安装的过程中会自动帮助我们配置以上环境。由于本次实践使用Windows作为宿主机，因此安装较为方便。")]),s._v(" "),t("h2",{attrs:{id:"_2-初始化centos容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-初始化centos容器"}},[s._v("#")]),s._v(" 2. 初始化CentOS容器")]),s._v(" "),t("p",[s._v("首先创建基础镜像my-centos，基础镜像的centos版本为7，且里面安装了常用的工具，比如 vim、wget、zlib 等，由于docker commit命令打包镜像具有黑箱性，生成的镜像也被称为黑箱镜像，官方并不推荐这种方式，在此我们编写Dockerfile来指定容器的配置和构成：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("FROM centos:7\nLABEL MAINTAINER "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mahhss@foxmail.com"')]),s._v("\nVOLUME /my-centos\nRUN yum update -y "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y  gcc-c++ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y pcre pcre-devel "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y zlib zlib-devel "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y  openssl-devel "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y popt-devel "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y initscripts "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y net-tools\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("运行指令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker build -t centos-base "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("即可根据Dockerfile文件创建一个镜像centos-base，如下图所示：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/TyhRf0",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/TyhRf0.png",alt:"TyhRf0.png"}}),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"_3-在容器中安装keepalived与nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-在容器中安装keepalived与nginx"}},[s._v("#")]),s._v(" 3. 在容器中安装Keepalived与Nginx")]),s._v(" "),t("p",[s._v("运行指令以启动容器：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker run -it --name centos-temp -d --privileged centos_base /usr/sbin/init\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("其中使用privileged参数，表示容器内的root用户拥有真正的root权限，且因为容器内需要使用systemctl服务，需要加上/usr/sbin/init。创建后的centos-temp容器如下图所示：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/TyhfpV",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/TyhfpV.png",alt:"TyhfpV.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("接着运行指令以进入该容器内部：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it centos-temp "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接下来执行以下命令来安装Nginx的依赖库以及Nginx本身，并启动Nginx服务。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装nginx的依赖库")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装nginx")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y nginx\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动nginx")]),s._v("\nsystemctl start nginx.service\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 测试nginx是否安装成功，若安装成功会显示nginx的欢迎界面的html代码。注：该容器的IP为172.17.0.2，通过ifconfig查看")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("在执行curl后可以得到如下图的结果：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyhom4",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyhom4.png",alt:"Tyhom4.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("安装Nginx后，通过yum安装Keepalived：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载Keepalived")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y keepalived\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份配置文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.backup\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除默认的配置文件，自己重新创建一个keepalived.conf文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/keepalived/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f keepalived.conf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" keepalived.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("打开配置文件后，按照如下设定编写配置：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("vrrp_script chk_nginx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx心跳检测脚本")]),s._v('\n\tscript "/etc/keepalived/nginx_check.sh"\n\tinterval 2\n\tweight '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定master")]),s._v("\n\tstate MASTER\n\tinterface eth0 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由id，所有服务器指定一致")]),s._v("\n\tvirtual_router_id 121\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前容器ip地址")]),s._v("\n\tmcast_src_ip 172.17.0.2\n\tpriority 100\n\tnopreempt\n\tadvert_int 1\n\tauthentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass 1234\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\ttrack_script "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tchk_nginx\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟ip")]),s._v("\n\tvirtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t172.17.0.100\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("keepalived是通过检测keepalived进程是否存在判断服务器是否宕机，如果keepalived 进程在但是nginx进程不在了那么keepalived是不会做主备切换的，所以我们需要写个脚本来监控nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在/etc/keepalived/目录下创建监控脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" nginx_check.sh\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 脚本内容")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx –no-header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$A")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    /usr/local/nginx/sbin/nginx\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -C nginx --no-header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("killall")]),s._v(" keepalived\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 给脚本赋予执行权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x nginx_check.sh\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# keepalived开机自启")]),s._v("\nsystemctl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" keepalived.service\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chkconfig")]),s._v(" keepalived on\nsystemctl start keepalived.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("接下来执行指令以测试虚拟IP是否成功挂载：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.100\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行结果如下图所示：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/TyhhlT",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/TyhhlT.png",alt:"TyhhlT.png"}}),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"_4-重新打包镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-重新打包镜像"}},[s._v("#")]),s._v(" 4. 重新打包镜像")]),s._v(" "),t("p",[s._v("在此我们将centos-temp 容器重新打包成镜像centos-kn，然后利用这个新镜像再创建两个容器centos-master和centos-slave，实现热备效果。执行以下指定重新打包镜像并删除原始镜像与容器：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建新的镜像centos-kn")]),s._v("\ndocker commit -a "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'masirr'")]),s._v(" -m "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'centos with keepalived nginx'")]),s._v(" centos-temp centos-kn\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除容器centos-temp")]),s._v("\ndocker container stop centos-temp\ndocker container "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" centos-temp\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用centos_kn镜像创建主服务器容器centos-master")]),s._v("\ndocker run --privileged  -tid --name centos-master --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always  centos-kn /usr/sbin/init\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("如下图所示，我们可以看到centos-master容器已经启动：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyh2Yq",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyh2Yq.png",alt:"Tyh2Yq.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("接来下进入centos-master ，修改centos-master容器里面nginx 欢迎页的标题为：Welcome to nginx master，用于区分我们当前访问的是master容器的nginx。")]),s._v(" "),t("p",[s._v("继续创建备用服务器容器centos-slave，并进入容器，修改keepalived.conf 配置文件，主要是state和priority、mcast_src_ip三个参数的调整，其中master节点的priority值必须要比slave大。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("vrrp_script chk_nginx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx心跳检测脚本")]),s._v('\n\tscript "/etc/keepalived/nginx_check.sh"\n\tinterval 2\n\tweight '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定master")]),s._v("\n\tstate SLAVE\n\tinterface eth0 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由id，所有服务器指定一致")]),s._v("\n\tvirtual_router_id 121\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前容器ip地址")]),s._v("\n\tmcast_src_ip 172.17.0.3\n\tpriority 80\n\tnopreempt\n\tadvert_int 1\n\tauthentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tauth_type PASS\n\t\tauth_pass 1234\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\ttrack_script "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tchk_nginx\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟ip")]),s._v("\n\tvirtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t172.17.0.100\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("修改centos-slave容器里面nginx 欢迎页的标题为：Welcome to nginx slave，用于区分我们当前访问的是slave容器的nginx。修改完后，重新加载keepalived服务：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("systemctl daemon-reload\nsystemctl restart keepalived.service\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("至此，我们就完成了两个服务器的所有配置工作，接下来为测试部分。")]),s._v(" "),t("h2",{attrs:{id:"_5-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-测试"}},[s._v("#")]),s._v(" 5. 测试")]),s._v(" "),t("p",[s._v("根据下图所示，我们可以看到目前主备容器都在运行中：")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyhgkn",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyhgkn.png",alt:"Tyhgkn.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("此时我们执行：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.100\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可以看到如下图的结果为master，这表明是主容器在响应我们的请求。")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyh46U",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyh46U.png",alt:"Tyh46U.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("当我们将主容器关掉时，可以看到如下图所示的容器运行情况。")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyh6Ts",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyh6Ts.png",alt:"Tyh6Ts.png"}}),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("再次执行：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.100\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("得到下图所示的结果，证明双机热备完成！")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://imgtu.com/i/Tyh5XF",target:"_blank",rel:"noopener noreferrer"}},[t("img",{attrs:{src:"https://s4.ax1x.com/2021/12/28/Tyh5XF.png",alt:"Tyh5XF.png"}}),t("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=e.exports}}]);