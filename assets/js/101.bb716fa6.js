(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{533:function(e,t,v){"use strict";v.r(t);var _=v(16),o=Object(_.a)({},(function(){var e=this,t=e.$createElement,v=e._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h1",{attrs:{id:"lab-2b"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#lab-2b"}},[e._v("#")]),e._v(" Lab 2B")]),e._v(" "),v("h2",{attrs:{id:"准备工作"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[e._v("#")]),e._v(" 准备工作")]),e._v(" "),v("p",[e._v("首先我们需要理解"),v("code",[e._v("Store")]),e._v("，"),v("code",[e._v("Peer")]),e._v("和"),v("code",[e._v("Region")]),e._v("的概念，它们在"),v("code",[e._v("proto/proto/metapb.proto")]),e._v("被定义。")]),e._v(" "),v("ul",[v("li",[v("code",[e._v("Store")]),e._v("表示的是一个"),v("code",[e._v("tinykv-server")]),e._v("的实例")]),e._v(" "),v("li",[v("code",[e._v("Peer")]),e._v("表示的是运行在"),v("code",[e._v("Store")]),e._v("中的Raft节点")]),e._v(" "),v("li",[v("code",[e._v("Region")]),e._v("是一个"),v("code",[e._v("Peer")]),e._v("的集合，也叫Raft组")])]),e._v(" "),v("p",[e._v("![TinyKV-Lab2B-1](C:\\Users\\Scott Ma\\Pictures\\博客图片\\TinyKV-Lab2B-1.png)")]),e._v(" "),v("p",[e._v("为了简单化，在这里我们假设一个"),v("code",[e._v("Store")]),e._v("里面只有一个"),v("code",[e._v("Peer")]),e._v("，一个集群中只有一个"),v("code",[e._v("Region")]),e._v("。")]),e._v(" "),v("h2",{attrs:{id:"需要看的代码"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#需要看的代码"}},[e._v("#")]),e._v(" 需要看的代码")]),e._v(" "),v("p",[e._v("首先要看"),v("code",[e._v("kv/storage/raft_storage/raft_server.go")]),e._v("中的"),v("code",[e._v("RaftStorage")]),e._v("，在这里也实现了"),v("code",[e._v("Storage")]),e._v("接口。不像"),v("code",[e._v("StandaloneStorage")]),e._v("那样直接从底层引擎中读写，这里是先把读写请求发送给Raft，然后在Raft commit后再做向底层引擎做真实读写，这样就可以保证一致性啦。")]),e._v(" "),v("p",[v("code",[e._v("RaftStorage")]),e._v("主要创建了一个"),v("code",[e._v("Raftstore")]),e._v("来去驱动Raft。当我们去调用"),v("code",[e._v("Reader")]),e._v("或者"),v("code",[e._v("Write")]),e._v("方法时，它会通过channel（接收channel是"),v("code",[e._v("raftWorker")]),e._v("中的"),v("code",[e._v("raftCh")]),e._v("）发送给"),v("code",[e._v("raftstore")]),e._v("一个包含四种命令类型的"),v("code",[e._v("RaftCmdRequest")]),e._v("（在"),v("code",[e._v("proto/proto/raft_cmdpb.proto")]),e._v("中定义），然后会在Raft commit并apply后返回结果。现在"),v("code",[e._v("Reader")]),e._v("和"),v("code",[e._v("Write")]),e._v("方法的"),v("code",[e._v("kvrpc.Context")]),e._v("参数就起作用啦，它会从客户端的视角携带"),v("code",[e._v("Region")]),e._v("信息并且以"),v("code",[e._v("RaftCmdRequest")]),e._v("头部的方式传递。也许这个消息是错的或者旧的，"),v("code",[e._v("raftstore")]),e._v("需要去检查一下并且决定是否要广播这个请求。")]),e._v(" "),v("ul",[v("li",[e._v("https://pingcap.com/blog-cn/the-design-and-implementation-of-multi-raft/#raftstore (Chinese Version)")])]),e._v(" "),v("p",[v("code",[e._v("raftstore")]),e._v("的入口是"),v("code",[e._v("Raftstore")]),e._v("，见"),v("code",[e._v("kv/raftstore/raftstore.go")]),e._v("。它启动了一些Worker 来异步处理特定的任务，现在大部分都没有用到，所以你可以直接忽略它们。你所需要关注的是"),v("code",[e._v("raftWorker")]),e._v("。("),v("code",[e._v("kv/raftstore/raft_worker.go")]),e._v(")")]),e._v(" "),v("p",[e._v("整个过程分为两部分：")]),e._v(" "),v("ol",[v("li",[e._v("raft worker 轮询"),v("code",[e._v("raftCh")]),e._v("以获得消息，这些消息包括驱动Raft模块的基本 tick 和作为 Raft 日志项需要广播的Raft命令；")]),e._v(" "),v("li",[e._v("它从Raft模块获得并处理ready，包括发送raft消息、持久化状态、将提交的日志项应用到状态机。一旦应用，将响应返回给客户。")])]),e._v(" "),v("h2",{attrs:{id:"实现peer-storage"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#实现peer-storage"}},[e._v("#")]),e._v(" 实现Peer Storage")])])}),[],!1,null,null,null);t.default=o.exports}}]);